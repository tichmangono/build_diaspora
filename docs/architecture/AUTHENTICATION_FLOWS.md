# Authentication Flows - BuildDiaspora Zimbabwe

## Overview

This document outlines the comprehensive authentication flows implemented in the BuildDiaspora Zimbabwe platform, including user registration, login, verification, password management, and security measures.

## Authentication Architecture

### Core Components

1. **Supabase Auth**: Primary authentication service
2. **Next.js Middleware**: Route protection and session validation
3. **Client-side Auth Context**: React context for auth state management
4. **Email Service**: Multi-provider email verification and notifications
5. **Security Middleware**: Input sanitization and rate limiting

## User Registration Flow

### Registration Process Overview
```
User Form → Client Validation → Supabase Auth → Profile Creation → 
Welcome Email → Verification Email → Email Verification → Dashboard Access
```

### Detailed Registration Steps

1. **Form Submission** (`/auth/register`)
   - User fills registration form with email, password, full name, profession, location
   - Client-side validation using Zod schemas
   - Password strength validation (8+ chars, mixed case, numbers, symbols)

2. **Supabase Registration**
   - Call `supabase.auth.signUp()` with user credentials
   - User metadata stored in auth.users table
   - Automatic email confirmation token generation

3. **Profile Creation**
   - Extended profile created in `public.profiles` table
   - Additional user information stored (profession, location, bio)
   - Default role assignment ('user')

4. **Email Notifications**
   - Welcome email sent immediately
   - Email verification link sent with secure token
   - Both emails use professional templates

5. **Email Verification**
   - User clicks verification link from email
   - Token validated via Supabase Auth
   - `email_verified_at` timestamp updated in profile
   - User redirected to dashboard

### Registration Security Features

- **Rate Limiting**: 5 registration attempts per IP per hour
- **Input Sanitization**: All form inputs sanitized for XSS prevention
- **Password Validation**: Enforced complexity requirements
- **Email Validation**: Domain validation and format checking
- **Duplicate Prevention**: Email uniqueness enforced at database level

## User Login Flow

### Login Process Overview
```
Credentials → Rate Limit Check → Supabase Auth → Email Verification Check → 
Security Monitoring → Session Creation → Dashboard Redirect
```

### Detailed Login Steps

1. **Credential Validation**
   - Email and password validation
   - Rate limiting check (5 attempts per 15 minutes)
   - Input sanitization for security

2. **Authentication**
   - `supabase.auth.signInWithPassword()` call
   - Session token generation
   - User metadata retrieval

3. **Email Verification Check**
   - Verify `email_confirmed_at` is not null
   - Redirect to verification page if unverified
   - Block access to protected routes

4. **Security Monitoring**
   - IP address and location tracking
   - User agent analysis for suspicious activity
   - Login pattern analysis
   - Security alert emails for unusual activity

5. **Session Management**
   - JWT token storage in HTTP-only cookies
   - Session expiration handling
   - Automatic token refresh

### Login Security Features

- **Account Lockout**: Temporary lockout after 5 failed attempts
- **Suspicious Activity Detection**: Unusual IP/location monitoring
- **Security Alerts**: Email notifications for suspicious logins
- **Session Security**: Secure token storage and rotation
- **Device Tracking**: Login device and location logging

## Password Management

### Password Reset Flow
```
Reset Request → Email Validation → Reset Email → Token Validation → 
New Password → Password Update → Confirmation Email → Auto Login
```

### Password Reset Implementation

1. **Reset Request**
   - User enters email address
   - Rate limiting applied (3 requests per hour per email)
   - Generic success message shown (security best practice)

2. **Reset Email**
   - Secure reset token generated by Supabase
   - Reset link with token sent via email
   - Token expires in 1 hour

3. **Password Update**
   - User clicks reset link and enters new password
   - Password strength validation enforced
   - Token validated and consumed
   - Password updated in Supabase Auth

4. **Security Notifications**
   - Password change confirmation email sent
   - Security event logged in audit trail
   - All existing sessions invalidated

### Password Security Features

- **Strength Requirements**: Complex password policy enforced
- **Token Security**: One-time use tokens with expiration
- **Session Invalidation**: All sessions terminated on password change
- **Audit Logging**: All password changes logged
- **Rate Limiting**: Reset request frequency limited

## Email Verification System

### Verification Flow
```
Registration → Verification Email → Link Click → Token Validation → 
Email Confirmation → Profile Update → Dashboard Access
```

### Verification Implementation

1. **Verification Email Generation**
   - Secure token generated by Supabase
   - Professional email template with clear instructions
   - Token embedded in verification URL

2. **Token Validation**
   - User clicks verification link
   - Token extracted from URL parameters
   - Validation via Supabase Auth API

3. **Account Activation**
   - `email_verified_at` timestamp updated
   - User session updated
   - Access to protected features enabled

4. **Resend Mechanism**
   - Users can request new verification emails
   - Rate limiting applied (3 requests per hour)
   - Previous tokens remain valid until expiration

## Session Management

### Client-Side Session Handling

**AuthContext Implementation**:
```typescript
// Session state management
const [user, setUser] = useState<User | null>(null)
const [loading, setLoading] = useState(true)

// Auth state listener
supabase.auth.onAuthStateChange((event, session) => {
  setUser(session?.user ?? null)
  handleAuthEvent(event, session)
})
```

### Server-Side Session Validation

**Middleware Protection**:
```typescript
// Route protection middleware
export async function middleware(request: NextRequest) {
  const supabase = createMiddlewareClient({ req: request })
  const { data: { session } } = await supabase.auth.getSession()
  
  // Protect authenticated routes
  if (isProtectedRoute && !session) {
    return redirectToLogin(request)
  }
  
  // Admin route protection
  if (isAdminRoute) {
    return validateAdminAccess(session)
  }
}
```

### Session Security Features

- **HTTP-Only Cookies**: Secure token storage
- **Automatic Refresh**: Token rotation before expiration
- **Session Timeout**: Configurable session duration
- **Device Tracking**: Multiple device session management
- **Secure Logout**: Complete session cleanup

## Multi-Factor Authentication (Future)

### Planned MFA Implementation

1. **TOTP (Time-based One-Time Password)**
   - Google Authenticator / Authy support
   - QR code setup process
   - Backup codes generation

2. **SMS Verification**
   - Phone number verification
   - SMS-based login codes
   - International SMS support

3. **Email-based MFA**
   - Email verification codes
   - Fallback for other MFA methods
   - Time-limited codes

## Security Monitoring

### Authentication Metrics Tracked

- **Login Success/Failure Rates**
- **Password Reset Frequency**
- **Email Verification Completion**
- **Session Duration Patterns**
- **Failed Login Attempt Patterns**

### Security Event Logging

- **Authentication Events**: Login, logout, registration
- **Security Events**: Failed attempts, suspicious activity
- **Password Events**: Changes, resets, strength violations
- **Session Events**: Creation, expiration, invalidation
- **Admin Events**: Role changes, permission modifications

### Automated Security Responses

- **Account Lockout**: Automatic lockout after failed attempts
- **Rate Limiting**: Request frequency restrictions
- **Security Alerts**: Email notifications for suspicious activity
- **Session Termination**: Automatic logout for security violations
- **IP Blocking**: Temporary blocks for malicious IPs

## Error Handling

### Authentication Error Categories

1. **Credential Errors**
   - Invalid email/password combinations
   - Account not found
   - Password too weak

2. **Account Status Errors**
   - Email not verified
   - Account locked/suspended
   - Account deleted

3. **Security Errors**
   - Rate limit exceeded
   - Suspicious activity detected
   - Invalid tokens

4. **System Errors**
   - Service unavailable
   - Database connection issues
   - Email delivery failures

### Error Response Strategy

- **User-Friendly Messages**: Clear, actionable error descriptions
- **Security Considerations**: Generic messages for sensitive errors
- **Logging**: Detailed error logging for debugging
- **Recovery Options**: Clear next steps for users
- **Support Contact**: Help desk information for complex issues

## Compliance & Privacy

### Data Protection

- **GDPR Compliance**: Right to access, rectify, delete personal data
- **CCPA Compliance**: Data portability and deletion rights
- **Data Minimization**: Only necessary data collected
- **Encryption**: All sensitive data encrypted at rest and in transit
- **Audit Trails**: Complete logging of data access and modifications

### Privacy Features

- **Consent Management**: Clear consent for data processing
- **Data Retention**: Automatic cleanup of expired data
- **Anonymization**: User data anonymization options
- **Export**: User data export functionality
- **Deletion**: Complete account and data deletion

---

This authentication system provides enterprise-grade security while maintaining excellent user experience, ensuring the BuildDiaspora Zimbabwe platform can safely handle sensitive professional verification data. 